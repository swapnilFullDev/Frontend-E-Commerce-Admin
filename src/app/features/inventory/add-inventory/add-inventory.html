<div class="relative">
  <div class="flex justify-between items-center" >
    <h2 mat-dialog-title>{{ isEdit ? 'Edit Inventory Item' : 'Add Inventory Item' }}</h2>
    <button mat-icon-button class="absolute right-5 z-10 square-icon-btn" (click)="onCancel()">
      <mat-icon>close</mat-icon>
    </button>    
  </div>
</div>

<form [formGroup]="inventoryForm" mat-dialog-content class="!p-0">
  <mat-horizontal-stepper [linear]="false" #stepper>
    <!-- Step 1: Basic Info -->
    <mat-step>
      <ng-template matStepLabel>Basic Info</ng-template>

      <mat-form-field appearance="fill" class="w-full mb-3">
        <mat-label>Product Name</mat-label>
        <input matInput formControlName="productName" required />
        <app-form-validation [control]="inventoryForm.get('productName')" fieldName="Product Name"></app-form-validation>
      </mat-form-field>

      <mat-form-field appearance="fill" class="w-full mb-3">
        <mat-label>Description</mat-label>
        <textarea matInput formControlName="description" required rows="3"></textarea>
        <app-form-validation [control]="inventoryForm.get('description')" fieldName="Description"></app-form-validation>
      </mat-form-field>

      <mat-form-field appearance="fill" class="w-full mb-3">
        <mat-label>Category</mat-label>
        <mat-select formControlName="category" required>
          <mat-option *ngFor="let category of categoryOptions" [value]="category">
            {{ category }}
          </mat-option>
        </mat-select>
        <app-form-validation [control]="inventoryForm.get('category')" fieldName="Category"></app-form-validation>
      </mat-form-field>

      <mat-form-field appearance="fill" class="w-full mb-3">
        <mat-label>Brand</mat-label>
        <input matInput formControlName="brand" required />
      </mat-form-field>
      <app-form-validation [control]="inventoryForm.get('brand')" fieldName="Brand"></app-form-validation>

      <div class="mb-3">
        <mat-checkbox formControlName="isReturnAcceptable">Return Acceptable</mat-checkbox>
      </div>

      <div class="flex justify-end mt-4">
        <button mat-button matStepperNext>Next</button>
      </div>
    </mat-step>

    <!-- Step 2: Images -->
    <mat-step>
      <ng-template matStepLabel>Images</ng-template>

      <div class="mb-3 text-center">
        <input type="file" multiple accept="image/*" (change)="onFilesSelected($event)" style="display: none" #fileInput />
        <button mat-fab color="primary" (click)="fileInput.click()" [disabled]="!canAddImage">
          <mat-icon>cloud_upload</mat-icon>
        </button>
        <p class="mt-2 text-sm text-gray-600">Click to upload images ({{ images.length }}/5)</p>
      </div>

      <div class="grid grid-cols-3 gap-2 min-h-modal">
        @if(images.length > 0){
          @for (img of images.controls; track $index) {
            <div class="relative group">          
              <!-- Wrapper controls positioning -->
              <div class="absolute top-1 right-1 z-20">
                <button mat-mini-fab color="warn" (click)="removeImage($index)" 
                class="!w-6 !h-6 !min-w-0 flex items-center justify-center align-center"
                [disabled]="!canRemoveImage"
                >
                  <mat-icon class="!text-sm cross-btn-size">close</mat-icon>
                </button>
              </div>
              @if(img.value.preview){
                <img [src]="img.value.preview"
                  class="w-full object-cover rounded-lg"
                />
              }
          
            </div>
          }
        }
      </div>

      <div class="flex justify-end mt-4">
        <button mat-button matStepperPrevious>Back</button>
        <button mat-button matStepperNext>Next</button>
      </div>
    </mat-step>

    <!-- Step 3: Variants -->
    <mat-step>
      <ng-template matStepLabel>Variants</ng-template>

      <div formArrayName="variants" class="inventory-varients-container">
        @for (variant of variants.controls; track $index) {
          <div [formGroupName]="$index" class="mb-2 p-2 border rounded">
            <div class="grid grid-cols-2 gap-3">
              <mat-form-field appearance="fill">
                <mat-label>Size</mat-label>
                <input matInput formControlName="size" required />
              </mat-form-field>
  
              <mat-form-field appearance="fill">
                <mat-label>Color</mat-label>
                <input matInput formControlName="color" required />
              </mat-form-field>
  
              <mat-form-field appearance="fill">
                <mat-label>Quantity</mat-label>
                <input matInput type="number" formControlName="qty" required min="0" />
              </mat-form-field>
  
              <mat-form-field appearance="fill">
                <mat-label>Price</mat-label>
                <input matInput type="number" formControlName="price" required min="0" />
              </mat-form-field>
  
              <mat-form-field appearance="fill">
                <mat-label>Rental Price</mat-label>
                <input matInput type="number" formControlName="rentalPrice" required min="0" />
              </mat-form-field>
  
              <mat-form-field appearance="fill">
                <mat-label>Advance Price</mat-label>
                <input matInput type="number" formControlName="advancePrice" required min="0" />
              </mat-form-field>
  
              <mat-form-field appearance="fill">
                <mat-label>Minimum Days Rental</mat-label>
                <input matInput formControlName="minimumDaysRental" required />
              </mat-form-field>

              <button mat-mini-fab color="warn" (click)="removeVariant($index)" class="mt-2" [disabled]="!canRemoveVariant">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
  
          </div>
        }
      </div>

      <button mat-stroked-button (click)="addVariant()" class="mb-4" [disabled]="!canAddVariant">
        <mat-icon>add</mat-icon> Add Variant ({{ variants.length }}/10)
      </button>

      <div class="flex justify-end mt-4">
        <button mat-button matStepperPrevious>Back</button>
        <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="inventoryForm.invalid">
          {{ isEdit ? 'Update' : 'Create' }} Product
        </button>
      </div>
    </mat-step>
  </mat-horizontal-stepper>
</form>